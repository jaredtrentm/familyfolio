// FamilyFolio - Prisma Schema
// Family investment portfolio tracking with transaction claiming

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String   // bcrypt hashed
  name         String
  pin          String?  // optional 4-digit PIN for quick access
  locale       String   @default("en") // en or zh
  role         String   @default("user") // user or admin
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Password reset
  passwordResetToken   String?   // hashed token
  passwordResetExpires DateTime? // token expiry

  // Relations
  transactions Transaction[] // claimed transactions
  dataUploads  DataUpload[]
  chatMessages ChatMessage[]
  accounts     Account[]
  links        Link[]
  plaidConnections PlaidConnection[]

  // Share requests
  sentShareRequests     ShareRequest[] @relation("SentShareRequests")
  receivedShareRequests ShareRequest[] @relation("ReceivedShareRequests")

  // New feature relations
  preferences        UserPreferences?
  priceAlerts        PriceAlert[]
  watchlist          WatchlistItem[]
  portfolioSnapshots PortfolioSnapshot[]
  rebalanceTargets   RebalanceTarget[]
  notifications      Notification[]
  transactionHistory TransactionHistory[]
}

model Account {
  id           String   @id @default(cuid())
  userId       String
  name         String   // e.g., "Schwab", "Robinhood", "Fidelity"
  cashBalance  Float    @default(0) // Cash sitting in the account
  isShared     Boolean  @default(false) // Shared family account like Schwab
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
  dataUploads  DataUpload[]
  plaidAccounts PlaidAccount[]

  @@index([userId])
}

model DataUpload {
  id           String   @id @default(cuid())
  userId       String
  accountId    String?  // Which account this upload is from
  filename     String
  fileType     String   // csv, image, pdf
  status       String   @default("pending") // pending, processing, completed, failed
  errorMessage String?
  rawData      String?  // JSON string of parsed data
  createdAt    DateTime @default(now())

  // Relations
  user         User         @relation(fields: [userId], references: [id])
  account      Account?     @relation(fields: [accountId], references: [id])
  transactions Transaction[]

  @@index([userId])
  @@index([accountId])
}

model Transaction {
  id           String   @id @default(cuid())
  dataUploadId String?
  claimedById  String?  // null = unclaimed (shared pool)
  accountId    String?  // Which account this transaction is from

  // Transaction details
  date         DateTime
  type         String   // BUY, SELL, DIVIDEND
  symbol       String
  description  String?
  quantity     Float
  price        Float
  amount       Float    // total value (quantity * price for trades)
  fees         Float    @default(0)
  currency     String   @default("USD")

  // Notes and wash sale tracking
  notes          String?
  washSaleFlag   Boolean @default(false)
  washSaleAmount Float?

  // Duplicate detection
  isDuplicateFlag Boolean  @default(false)
  duplicateOfId   String?  // ID of the transaction this is a duplicate of
  duplicateScore  Int?     // Match confidence score (0-100)

  // Metadata
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  dataUpload   DataUpload? @relation(fields: [dataUploadId], references: [id])
  claimedBy    User?       @relation(fields: [claimedById], references: [id])
  account      Account?    @relation(fields: [accountId], references: [id])
  taxLots      TaxLot[]
  history      TransactionHistory[]

  @@index([claimedById])
  @@index([symbol])
  @@index([date])
  @@index([accountId])
}

model StockCache {
  id           String   @id @default(cuid())
  symbol       String   @unique
  name         String?
  currentPrice Float?
  dayChange    Float?
  dayChangePercent Float?
  previousClose Float?
  marketCap    Float?
  sector       String?
  industry     String?
  isEtf        Boolean  @default(false)
  updatedAt    DateTime @updatedAt

  // ETF holdings relation
  etfHoldings  EtfHolding[]

  @@index([symbol])
}

// ETF holdings for sector breakdown
model EtfHolding {
  id           String   @id @default(cuid())
  etfSymbol    String   // The ETF symbol (e.g., VTI)
  holdingSymbol String  // The underlying holding symbol (e.g., AAPL)
  holdingName  String?
  weight       Float    // Percentage weight (0-100)
  sector       String?
  updatedAt    DateTime @updatedAt

  // Relation to parent ETF
  etf          StockCache @relation(fields: [etfSymbol], references: [symbol])

  @@unique([etfSymbol, holdingSymbol])
  @@index([etfSymbol])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  role      String   // user, assistant
  content   String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Link {
  id          String   @id @default(cuid())
  userId      String
  accountId   String?  // Optional: associate with specific account
  name        String   // Display name (e.g., "Schwab Login", "Yahoo Finance")
  url         String
  category    String   @default("other") // account, research, news, other
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([accountId])
}

// Share requests for unclaimed transactions pool
model ShareRequest {
  id            String   @id @default(cuid())
  requesterId   String   // User who sent the request
  targetId      String   // User who receives the request
  status        String   @default("pending") // pending, approved, denied
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  requester     User     @relation("SentShareRequests", fields: [requesterId], references: [id])
  target        User     @relation("ReceivedShareRequests", fields: [targetId], references: [id])

  @@unique([requesterId, targetId]) // Prevent duplicate requests
  @@index([requesterId])
  @@index([targetId])
  @@index([status])
}

// Plaid integration - bank connection
model PlaidConnection {
  id              String   @id @default(cuid())
  userId          String
  accessToken     String   // encrypted
  itemId          String   @unique
  institutionId   String?
  institutionName String
  status          String   @default("active") // active, error, pending_expiration
  consentExpiresAt DateTime?
  lastSyncedAt    DateTime?
  errorCode       String?
  errorMessage    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts        PlaidAccount[]

  @@index([userId])
  @@index([itemId])
}

// Plaid accounts within a connection
model PlaidAccount {
  id             String   @id @default(cuid())
  connectionId   String
  plaidAccountId String   @unique
  name           String
  officialName   String?
  type           String   // investment, depository, credit, loan, brokerage
  subtype        String?
  mask           String?  // Last 4 digits
  isActive       Boolean  @default(true)

  // Link to local account (optional - user can map Plaid account to their Account)
  localAccountId String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  connection     PlaidConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  localAccount   Account?        @relation(fields: [localAccountId], references: [id])

  @@index([connectionId])
  @@index([plaidAccountId])
}

// Tax lot tracking for cost basis calculations
model TaxLot {
  id            String   @id @default(cuid())
  transactionId String
  symbol        String
  quantity      Float
  remainingQty  Float
  costBasis     Float
  acquiredDate  DateTime
  createdAt     DateTime @default(now())

  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([symbol])
  @@index([transactionId])
}

// Transaction history for undo/audit
model TransactionHistory {
  id            String   @id @default(cuid())
  transactionId String
  userId        String
  changeType    String   // CREATE, UPDATE, DELETE, CLAIM, UNCLAIM
  previousData  Json?
  newData       Json?
  createdAt     DateTime @default(now())

  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  user          User @relation(fields: [userId], references: [id])

  @@index([transactionId])
  @@index([userId])
}

// User preferences including widget layout and cost basis method
model UserPreferences {
  id              String   @id @default(cuid())
  userId          String   @unique
  widgetLayout    Json?
  costBasisMethod String   @default("FIFO")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User @relation(fields: [userId], references: [id])
}

// Price alerts for stock notifications
model PriceAlert {
  id          String    @id @default(cuid())
  userId      String
  symbol      String
  targetPrice Float
  condition   String    // ABOVE, BELOW
  isActive    Boolean   @default(true)
  triggeredAt DateTime?
  createdAt   DateTime  @default(now())

  user        User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([symbol, isActive])
}

// Watchlist items for tracking stocks
model WatchlistItem {
  id        String   @id @default(cuid())
  userId    String
  symbol    String
  notes     String?
  addedAt   DateTime @default(now())

  user      User @relation(fields: [userId], references: [id])

  @@unique([userId, symbol])
}

// Portfolio snapshots for historical tracking
model PortfolioSnapshot {
  id           String   @id @default(cuid())
  userId       String
  snapshotDate DateTime
  totalValue   Float
  costBasis    Float
  holdings     Json
  createdAt    DateTime @default(now())

  user         User @relation(fields: [userId], references: [id])

  @@index([userId, snapshotDate])
}

// Rebalancing targets for portfolio allocation
model RebalanceTarget {
  id            String   @id @default(cuid())
  userId        String
  targetType    String   // SYMBOL, SECTOR, ASSET_TYPE
  identifier    String
  targetPercent Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User @relation(fields: [userId], references: [id])

  @@unique([userId, targetType, identifier])
}

// In-app notifications
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // PRICE_ALERT, WEEKLY_REPORT, SYSTEM
  title     String
  message   String
  isRead    Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())

  user      User @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
}
