// FamilyFolio - Prisma Schema
// Family investment portfolio tracking with transaction claiming

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String   // bcrypt hashed
  name         String
  pin          String?  // optional 4-digit PIN for quick access
  locale       String   @default("en") // en or zh
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Password reset
  passwordResetToken   String?   // hashed token
  passwordResetExpires DateTime? // token expiry

  // Relations
  transactions Transaction[] // claimed transactions
  dataUploads  DataUpload[]
  chatMessages ChatMessage[]
  accounts     Account[]
  links        Link[]

  // Share requests
  sentShareRequests     ShareRequest[] @relation("SentShareRequests")
  receivedShareRequests ShareRequest[] @relation("ReceivedShareRequests")
}

model Account {
  id           String   @id @default(cuid())
  userId       String
  name         String   // e.g., "Schwab", "Robinhood", "Fidelity"
  cashBalance  Float    @default(0) // Cash sitting in the account
  isShared     Boolean  @default(false) // Shared family account like Schwab
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id])
  transactions Transaction[]
  dataUploads  DataUpload[]

  @@index([userId])
}

model DataUpload {
  id           String   @id @default(cuid())
  userId       String
  accountId    String?  // Which account this upload is from
  filename     String
  fileType     String   // csv, image, pdf
  status       String   @default("pending") // pending, processing, completed, failed
  errorMessage String?
  rawData      String?  // JSON string of parsed data
  createdAt    DateTime @default(now())

  // Relations
  user         User         @relation(fields: [userId], references: [id])
  account      Account?     @relation(fields: [accountId], references: [id])
  transactions Transaction[]

  @@index([userId])
  @@index([accountId])
}

model Transaction {
  id           String   @id @default(cuid())
  dataUploadId String?
  claimedById  String?  // null = unclaimed (shared pool)
  accountId    String?  // Which account this transaction is from

  // Transaction details
  date         DateTime
  type         String   // BUY, SELL, DIVIDEND
  symbol       String
  description  String?
  quantity     Float
  price        Float
  amount       Float    // total value (quantity * price for trades)
  fees         Float    @default(0)
  currency     String   @default("USD")

  // Duplicate detection
  isDuplicateFlag Boolean  @default(false)
  duplicateOfId   String?  // ID of the transaction this is a duplicate of
  duplicateScore  Int?     // Match confidence score (0-100)

  // Metadata
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  dataUpload   DataUpload? @relation(fields: [dataUploadId], references: [id])
  claimedBy    User?       @relation(fields: [claimedById], references: [id])
  account      Account?    @relation(fields: [accountId], references: [id])

  @@index([claimedById])
  @@index([symbol])
  @@index([date])
  @@index([accountId])
}

model StockCache {
  id           String   @id @default(cuid())
  symbol       String   @unique
  name         String?
  currentPrice Float?
  dayChange    Float?
  dayChangePercent Float?
  previousClose Float?
  marketCap    Float?
  sector       String?
  industry     String?
  isEtf        Boolean  @default(false)
  updatedAt    DateTime @updatedAt

  // ETF holdings relation
  etfHoldings  EtfHolding[]

  @@index([symbol])
}

// ETF holdings for sector breakdown
model EtfHolding {
  id           String   @id @default(cuid())
  etfSymbol    String   // The ETF symbol (e.g., VTI)
  holdingSymbol String  // The underlying holding symbol (e.g., AAPL)
  holdingName  String?
  weight       Float    // Percentage weight (0-100)
  sector       String?
  updatedAt    DateTime @updatedAt

  // Relation to parent ETF
  etf          StockCache @relation(fields: [etfSymbol], references: [symbol])

  @@unique([etfSymbol, holdingSymbol])
  @@index([etfSymbol])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  role      String   // user, assistant
  content   String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Link {
  id          String   @id @default(cuid())
  userId      String
  accountId   String?  // Optional: associate with specific account
  name        String   // Display name (e.g., "Schwab Login", "Yahoo Finance")
  url         String
  category    String   @default("other") // account, research, news, other
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([accountId])
}

// Share requests for unclaimed transactions pool
model ShareRequest {
  id            String   @id @default(cuid())
  requesterId   String   // User who sent the request
  targetId      String   // User who receives the request
  status        String   @default("pending") // pending, approved, denied
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  requester     User     @relation("SentShareRequests", fields: [requesterId], references: [id])
  target        User     @relation("ReceivedShareRequests", fields: [targetId], references: [id])

  @@unique([requesterId, targetId]) // Prevent duplicate requests
  @@index([requesterId])
  @@index([targetId])
  @@index([status])
}
